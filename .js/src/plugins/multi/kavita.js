var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(a,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var r,n,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}a[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("@libs/fetch"),a=require("@libs/novelStatus"),s=require("@libs/storage"),i=function(){function i(){this.id="kavita",this.name="Kavita",this.icon="src/multi/kavita/icon.png",this.site=s.storage.get("url"),this.apiKey=s.storage.get("apiKey"),this.version="1.0.1",this.filters=void 0,this.imageRequestInit=void 0,this.webStorageUtilized=!0,this.pluginSettings={url:{value:"",label:"URL",type:"Text"},apiKey:{value:"",label:"Api Key",type:"Text"}}}return i.prototype.getSite=function(){if(this.site||(this.site=s.storage.get("url")),!this.site)throw new Error("Must configure a valid URL");return this.site.endsWith("/")?this.site:this.site+"/"},i.prototype.genHeaders=function(a){return t(this,void 0,void 0,(function(){var t,i,o,c;return r(this,(function(r){switch(r.label){case 0:if(this.apiKey||(this.apiKey=s.storage.get("apiKey")),!this.apiKey)throw new Error("Must enter a valid api key");return void 0!==this.user&&void 0!==this.user.token||(this.user=s.storage.get("user")||void 0),void 0!==this.user&&void 0!==this.user.token?[3,2]:(t=this,[4,(0,n.fetchApi)("".concat(this.getSite(),"api/Account/login"),{method:"POST",body:JSON.stringify({username:"",password:"",apiKey:this.apiKey}),headers:{"Content-Type":"application/json"}}).then((function(e){return e.json()}))]);case 1:t.user=r.sent(),s.storage.set("user",this.user),r.label=2;case 2:if(void 0===this.user||void 0===this.user.token)throw new Error("Unable to log into kavita");return u=this.user.token,l=u.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),p=decodeURIComponent(function(e){void 0===e&&(e="");var t=e.replace(/=+$/,""),r="";if(t.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var n=0,a=0,s=void 0,i=0;s=t.charAt(i++);~s&&(a=n%4?64*a+s:s,n++%4)?r+=String.fromCharCode(255&a>>(-2*n&6)):0)s=h.indexOf(s);return r}(l).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join("")),i=JSON.parse(p),Date.now()>=1e3*i.exp?[4,(0,n.fetchApi)("".concat(this.getSite(),"api/Account/refresh-token"),{method:"POST",body:JSON.stringify({token:this.user.token,refreshToken:this.user.refreshToken}),headers:{"Content-Type":"application/json"}}).then((function(e){return e.json()}))]:[3,4];case 3:o=r.sent(),this.user.token=o.token,this.user.refreshToken=o.refreshToken,s.storage.set("user",this.user),r.label=4;case 4:return(c=void 0!==a?e({},a):{}).Authorization="Bearer ".concat(this.user.token),[2,c]}var u,l,p}))}))},i.prototype.getNovelsByFilter=function(e,a){return t(this,void 0,void 0,(function(){var t,s,i,o,c,u,l,h,p,d,f,g,v,y,m,b,S,w,C,T,k;return r(this,(function(r){switch(r.label){case 0:return t=[],i=n.fetchApi,o=["".concat(this.getSite(),"api/series/all-v2?pageNumber=").concat(a,"&pageSize=20")],T={method:"POST",body:JSON.stringify(e)},[4,this.genHeaders({"Content-Type":"application/json"})];case 1:return[4,i.apply(void 0,o.concat([(T.headers=r.sent(),T)]))];case 2:s=r.sent(),r.label=3;case 3:return r.trys.push([3,5,,6]),[4,s.json()];case 4:return c=r.sent(),[3,6];case 5:throw r.sent(),new Error("Failed to load novel series from kavita.");case 6:u=0,l=c,r.label=7;case 7:return u<l.length?(h=l[u],d=n.fetchApi,f=["".concat(this.getSite(),"api/series/series-detail?seriesId=").concat(h.id)],k={},[4,this.genHeaders()]):[3,11];case 8:return[4,d.apply(void 0,f.concat([(k.headers=r.sent(),k)])).then((function(e){return e.json()}))];case 9:for(p=r.sent(),g=p.volumes||[],v=0,y=g;v<y.length;v++)for(m=y[v],b=m.chapters||[],S=0,w=b;S<w.length;S++)C=w[S],t.push({name:C.titleName,path:"".concat(h.libraryId,"/").concat(h.id,"/").concat(C.id.toString()),cover:"".concat(this.getSite(),"api/Image/chapter-cover?chapterId=").concat(C.id,"&apiKey=").concat(this.apiKey)});r.label=10;case 10:return u++,[3,7];case 11:return[2,t]}}))}))},i.prototype.popularNovels=function(e,n){return t(this,arguments,void 0,(function(e,t){var n;t.showLatestNovels,t.filters;return r(this,(function(t){return n={id:0,name:"",statements:[{comparison:l.Contains,field:u.Formats,value:o.Epub}],combinations:1,sortOptions:{sortField:1,isAscending:!0},limitTo:0},[2,this.getNovelsByFilter(n,e)]}))}))},i.prototype.parseKavitaChapters=function(e,t,r,n,a,s,i,o){for(var c=[],u=n,l=0,h=e;l<h.length;l++){var p=h[l],d=p.children||[],f=r;if(u<e.length-1&&(f=e[u+1].page-1),d.length>0){var g=this.parseKavitaChapters(d,p.page,f,u,a,s,i,o);u+=g.length,c.push.apply(c,g)}else{var v={name:p.title,path:"".concat(s,"/").concat(i,"/").concat(o,"/").concat(u,"/").concat(p.page,"/").concat(f),releaseTime:a,chapterNumber:u};c.push(v),u++}}return c},i.prototype.parseNovel=function(e){return t(this,void 0,void 0,(function(){var t,s,i,o,u,l,h,p,d,f,g,v,y,m,b;return r(this,(function(r){switch(r.label){case 0:return t=e.split("/",3),s=t[0],i=t[1],o=t[2],u={path:e,name:"Untitled"},h=n.fetchApi,p=["".concat(this.getSite(),"api/Chapter?chapterId=").concat(o)],m={},[4,this.genHeaders()];case 1:return[4,h.apply(void 0,p.concat([(m.headers=r.sent(),m)]))];case 2:l=r.sent(),r.label=3;case 3:return r.trys.push([3,5,,6]),[4,l.json()];case 4:return d=r.sent(),[3,6];case 5:throw r.sent(),new Error("Failed to load novel from kavita.");case 6:return u.name=d.titleName,u.artist=(d.coverArtists||[]).filter((function(e){return e.name})).map((function(e){return e.name})).join(", "),u.author=(d.writers||[]).filter((function(e){return e.name})).map((function(e){return e.name})).join(", "),u.cover="".concat(this.getSite(),"api/Image/chapter-cover?chapterId=").concat(d.id,"&apiKey=").concat(this.apiKey),u.genres=(d.genres||[]).map((function(e){return e.title})).join(", "),u.status=function(e){switch(e){case c.Cancelled:return a.NovelStatus.Cancelled;case c.Completed:return a.NovelStatus.Completed;case c.Ended:return a.NovelStatus.PublishingFinished;case c.Hiatus:return a.NovelStatus.OnHiatus;case c.OnGoing:return a.NovelStatus.Ongoing}}(d.publicationStatus),u.summary=d.summary,g=n.fetchApi,v=["".concat(this.getSite(),"api/Book/").concat(d.id,"/chapters")],b={},[4,this.genHeaders()];case 7:return[4,g.apply(void 0,v.concat([(b.headers=r.sent(),b)]))];case 8:f=r.sent(),r.label=9;case 9:return r.trys.push([9,11,,12]),[4,f.json()];case 10:return y=r.sent(),[3,12];case 11:throw r.sent(),new Error("Failed to load novel chapters from kavita.");case 12:return u.chapters=this.parseKavitaChapters(y,0,d.pages,0,d.releaseDate,s,i,o),[2,u]}}))}))},i.prototype.parseChapter=function(e){return t(this,void 0,void 0,(function(){var t,a,s,i,o,c,u,l,h,p,d;return r(this,(function(r){switch(r.label){case 0:t=e.split("/",6),t[0],t[1],a=t[2],t[3],s=t[4],i=t[5],o="",c=parseInt(s),r.label=1;case 1:return c<=parseInt(i)?(l=n.fetchApi,h=["".concat(this.getSite(),"api/Book/").concat(a,"/book-page?page=").concat(c)],d={},[4,this.genHeaders()]):[3,8];case 2:return[4,l.apply(void 0,h.concat([(d.headers=r.sent(),d)]))];case 3:u=r.sent(),r.label=4;case 4:return r.trys.push([4,6,,7]),p=o,[4,u.text()];case 5:return o=p+r.sent(),[3,7];case 6:throw r.sent(),new Error("Failed to load chapter from kavita.");case 7:return c++,[3,1];case 8:return[2,o]}}))}))},i.prototype.searchNovels=function(e,n){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){return t={id:0,name:"",statements:[{comparison:l.Contains,field:u.Formats,value:o.Epub},{comparison:l.Matches,field:u.SeriesName,value:e}],combinations:1,sortOptions:{sortField:1,isAscending:!0},limitTo:0},[2,this.getNovelsByFilter(t,n)]}))}))},i.prototype.resolveUrl=function(e,t){if(t){var r=e.split("/",3),n=r[0],a=r[1],s=r[2];return"".concat(this.getSite,"/library/").concat(n,"/series/").concat(a,"/chapter/").concat(s)}var i=e.split("/",6),o=i[0],c=i[1],u=i[2];i[3],i[4],i[5];return"".concat(this.getSite,"/library/").concat(o,"/series/").concat(c,"/chapter/").concat(u)},i}();exports.default=new i;var o,c,u,l,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";!function(e){e.Image="0",e.Archive="1",e.Unknown="2",e.Epub="3",e.Pdf="4"}(o||(o={})),function(e){e[e.OnGoing=0]="OnGoing",e[e.Hiatus=1]="Hiatus",e[e.Completed=2]="Completed",e[e.Cancelled=3]="Cancelled",e[e.Ended=4]="Ended"}(c||(c={})),function(e){e[e.Summary=0]="Summary",e[e.SeriesName=1]="SeriesName",e[e.PublicationStatus=2]="PublicationStatus",e[e.Languages=3]="Languages",e[e.AgeRating=4]="AgeRating",e[e.UserRating=5]="UserRating",e[e.Tags=6]="Tags",e[e.CollectionTags=7]="CollectionTags",e[e.Translators=8]="Translators",e[e.Characters=9]="Characters",e[e.Publisher=10]="Publisher",e[e.Editor=11]="Editor",e[e.CoverArtist=12]="CoverArtist",e[e.Letterer=13]="Letterer",e[e.Colorist=14]="Colorist",e[e.Inker=15]="Inker",e[e.Penciller=16]="Penciller",e[e.Writers=17]="Writers",e[e.Genres=18]="Genres",e[e.Libraries=19]="Libraries",e[e.ReadProgress=20]="ReadProgress",e[e.Formats=21]="Formats",e[e.ReleaseYear=22]="ReleaseYear",e[e.ReadTime=23]="ReadTime",e[e.Path=24]="Path",e[e.FilePath=25]="FilePath"}(u||(u={})),function(e){e[e.Equal=0]="Equal",e[e.GreaterThan=1]="GreaterThan",e[e.GreaterThanEqual=2]="GreaterThanEqual",e[e.LessThan=3]="LessThan",e[e.LessThanEqual=4]="LessThanEqual",e[e.Contains=5]="Contains",e[e.MustContains=6]="MustContains",e[e.Matches=7]="Matches",e[e.NotContains=8]="NotContains",e[e.NotEqual=9]="NotEqual",e[e.BeginsWith=10]="BeginsWith",e[e.EndsWith=11]="EndsWith",e[e.IsBefore=12]="IsBefore",e[e.IsAfter=13]="IsAfter",e[e.IsInLast=14]="IsInLast",e[e.IsNotInLast=15]="IsNotInLast"}(l||(l={}));